<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Visualizador 3D - Colores Reales</title>
    <style>
        /* Mantener los estilos existentes sin cambios */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #000; 
            overflow: hidden; 
            touch-action: none; 
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            position: fixed;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }
        /* Todos los dem√°s estilos sin cambios */
        #status {
            position: fixed;
            top: 10px;
            left: 10px;
            color: lime;
            font-family: monospace;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            z-index: 100;
            font-size: 14px;
            border-radius: 5px;
        }
        .audio-meter {
            position: fixed;
            bottom: 70px;
            left: 10px;
            width: 200px;
            height: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            overflow: hidden;
            z-index: 100;
        }
        .audio-meter-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #00ff00, #ffff00, #ff0000);
            transition: width 0.1s;
        }
        .instructions {
            position: fixed;
            bottom: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            z-index: 100;
            font-size: 14px;
            border-radius: 5px;
        }
        .button-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .control-button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.2s;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .control-button:active {
            background: rgba(255,255,255,0.4);
            transform: scale(0.95);
        }
        @media (max-width: 768px) {
            .control-button {
                font-size: 15px;
                padding: 14px 20px;
                margin-bottom: 5px;
            }
        }
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 1000;
        }
        #loading .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .preview {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            padding: 5px;
            overflow: hidden;
            z-index: 99;
            display: none;
        }
        .color-sample {
            position: fixed;
            bottom: 100px;
            right: 10px;
            width: 50px;
            height: 50px;
            border-radius: 5px;
            border: 2px solid white;
            z-index: 100;
        }
        @media (max-width: 768px) {
            .instructions { font-size: 12px; }
            .control-button { font-size: 14px; padding: 12px 16px; }
            .audio-meter { width: 150px; }
        }
        @keyframes buttonPress {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        .button-pressed {
            animation: buttonPress 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Mantener el HTML sin cambios -->
    <div id="loading">
        <div class="spinner"></div>
        <p>Cargando visualizador 3D...</p>
        <p id="loadingText">Iniciando...</p>
    </div>
    
    <div id="status">Inicializando...</div>
    
    <div class="audio-meter">
        <div class="audio-meter-fill" id="audioMeterFill"></div>
    </div>
    
    <div class="button-panel">
        <button class="control-button" id="photoButton">üì∏ Foto</button>
        <button class="control-button" id="recordButton">üî¥ Grabar</button>
        <button class="control-button" id="effectButton">üåà Efecto</button>
        <button class="control-button" id="cameraButton">üìπ Cambiar c√°mara</button>
        <button class="control-button" id="previewButton">üëÅÔ∏è Previsualizar</button>
    </div>
    
    <div class="preview" id="preview"></div>
    <div class="color-sample" id="colorSample"></div>
    
    <div class="instructions">
        <p>‚Ä¢ Desliza para rotar la vista</p>
        <p>‚Ä¢ Pellizca para zoom</p>
        <p>‚Ä¢ El medidor muestra el nivel de audio</p>
    </div>

    <!-- Scripts necesarios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/addons/p5.sound.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5.easycam@1.0.0/p5.easycam.min.js"></script>

    <script>
        // Variables globales - mantener sin cambios
        let canvas;
        let video;
        let mic;
        let offset = 0;
        let recording = false;
        let statusElement;
        let loadingElement;
        let loadingTextElement;
        let audioMeterFill;
        let colorSample;
        let showPreview = false;
        let previewElement;
        let chunks = [];
        let recorder;
        let isMobile = false;
        let canRecord = false;
        let usingBackCamera = false;
        let easycam;
        let hasBeenTouched = false;
        
        // Variables para efectos 3D - mantener sin cambios
        let depthFactor = 2.0;     
        let sphereSize = 3;        
        let pointDensity = 5;      
        let mobilePointDensity = 8; 
        let effectIntensity = 1.0;  
        
        // Variables de renderizado - mantener sin cambios
        let audioLevel = 0;
        let sampledColor = [255, 255, 255];
        
        // Variables para manejo de eventos - mantener sin cambios
        let canUseCameras = false;
        let canRenderScene = false;

        // Variables para manejo de errores
        let loadingTimeoutID = null;
        let fallbackModeActive = false;
        
        // Elementos del DOM - referencias globales - mantener sin cambios
        let photoButton, recordButton, effectButton, previewButton, cameraButton;
        
        // Detectar vibraci√≥n - mantener sin cambios
        const canVibrate = "vibrate" in navigator;
        
        // SOLUCI√ìN DE EMERGENCIA: Forzar finalizaci√≥n de carga despu√©s de un l√≠mite
        const FORCE_LOAD_TIMEOUT = 5000; // 5 segundos m√°ximo de espera

        // Funci√≥n para dar feedback t√°ctil - mantener sin cambios
        function vibrateDevice(duration = 50) {
            if (canVibrate) {
                try {
                    navigator.vibrate(duration);
                } catch (e) {
                    console.log("Vibraci√≥n no soportada");
                }
            }
        }
        
        // Funci√≥n mejorada para animaci√≥n de botones - mantener sin cambios
        function animateButton(button) {
            button.classList.add("button-pressed");
            setTimeout(() => {
                button.classList.remove("button-pressed");
            }, 300);
        }
        
        // Configurar todo tan pronto como el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM completamente cargado");
            initBasicElements();
        });
        
        // NUEVO: Funci√≥n para inicializar solo los elementos b√°sicos
        function initBasicElements() {
            // Configurar referencias a elementos DOM
            statusElement = document.getElementById('status');
            loadingElement = document.getElementById('loading');
            loadingTextElement = document.getElementById('loadingText');
            audioMeterFill = document.getElementById('audioMeterFill');
            colorSample = document.getElementById('colorSample');
            previewElement = document.getElementById('preview');
            
            // Configurar botones
            photoButton = document.getElementById('photoButton');
            recordButton = document.getElementById('recordButton');
            effectButton = document.getElementById('effectButton');
            previewButton = document.getElementById('previewButton');
            cameraButton = document.getElementById('cameraButton');
            
            // Detectar dispositivo m√≥vil de inmediato
            detectDevice();
            
            updateLoadingText("Elementos b√°sicos inicializados");
            
            // Configurar botones con eventos simples
            setupSimpleButtonEvents();
            
            // NUEVO: Establecer timeout de seguridad para forzar carga en cualquier caso
            loadingTimeoutID = setTimeout(function() {
                console.log("TIMEOUT DE EMERGENCIA - Forzando finalizaci√≥n de carga");
                hideLoading();
                updateStatus("Modo b√°sico activo");
                fallbackModeActive = true;
            }, FORCE_LOAD_TIMEOUT);
        }
        
        // NUEVO: Configuraci√≥n simplificada de botones
        function setupSimpleButtonEvents() {
            photoButton.onclick = takePhoto;
            recordButton.onclick = toggleRecording;
            effectButton.onclick = cycleEffect;
            previewButton.onclick = togglePreview;
            cameraButton.onclick = toggleCamera;
        }

        window.onload = function() {
            // La inicializaci√≥n b√°sica ya se hizo en DOMContentLoaded
            console.log("Window completamente cargada");
            updateLoadingText("Ventana completamente cargada");
            
            // Detectar si el navegador soporta MediaRecorder
            canRecord = (typeof MediaRecorder !== 'undefined');
            if (!canRecord) {
                recordButton.style.display = 'none';
            }
            
            // Prevenir gestos del navegador en dispositivos t√°ctiles
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
            
            // NUEVO: Asegurarse de que p5.js est√° disponible antes de continuar
            if (typeof p5 !== 'undefined') {
                updateLoadingText("Bibliotecas cargadas, iniciando setup...");
            } else {
                console.error("Error: p5.js no est√° disponible");
                updateLoadingText("Error: biblioteca p5.js no disponible");
                hideLoading();
                updateStatus("Error: modo limitado");
                return;
            }
        };
        
        function detectDevice() {
            // Detectar dispositivo: m√≥vil, tablet o desktop - mantener sin cambios
            const userAgent = navigator.userAgent.toLowerCase();
            const isMobileDevice = /android|webos|iphone|ipod|blackberry|iemobile|opera mini/.test(userAgent);
            const isTablet = /ipad|android/.test(userAgent) && !/mobile/.test(userAgent);
            
            isMobile = isMobileDevice || isTablet;
            
            if (isMobileDevice) {
                pointDensity = mobilePointDensity;
                sphereSize = 2.5;
                // NUEVO: Reducir a√∫n m√°s la densidad para m√≥viles problem√°ticos
                if (/iphone|ipod/.test(userAgent)) {
                    pointDensity = mobilePointDensity * 1.5;
                }
            } else if (isTablet) {
                pointDensity = 6;
                sphereSize = 3;
            }
            
            updateLoadingText("Detectado: " + (isMobileDevice ? "Dispositivo m√≥vil" : isTablet ? "Tablet" : "Escritorio"));
        }

        function updateLoadingText(text) {
            if (loadingTextElement) {
                loadingTextElement.textContent = text;
                console.log(text);
            }
        }
        
        function hideLoading() {
            if (loadingElement) {
                loadingElement.style.display = 'none';
                console.log("Pantalla de carga ocultada");
                
                // Limpiar timeout si existe
                if (loadingTimeoutID) {
                    clearTimeout(loadingTimeoutID);
                    loadingTimeoutID = null;
                }
            }
        }

        // MODIFICADO: Versi√≥n simplificada de setup para evitar bloqueos
        function setup() {
            try {
                updateLoadingText("Creando lienzo...");
                
                // Crear canvas con tama√±o reducido en m√≥viles
                if (isMobile) {
                    let canvasWidth = windowWidth;
                    let canvasHeight = windowHeight;
                    pixelDensity(1); // Forzar densidad de p√≠xeles a 1 para mejor rendimiento
                    canvas = createCanvas(canvasWidth, canvasHeight, WEBGL);
                } else {
                    canvas = createCanvas(windowWidth, windowHeight, WEBGL);
                }
                
                // NUEVO: Comprobar si el canvas se cre√≥ correctamente
                if (!canvas) {
                    throw new Error("No se pudo crear el canvas");
                }
                
                updateLoadingText("Lienzo creado, inicializando c√°mara 3D...");
                
                // Inicializar EasyCam con configuraci√≥n b√°sica
                try {
                    easycam = createEasyCam({
                        distance: 200,
                        center: [0, 0, 0]
                    });
                    updateLoadingText("EasyCam inicializada");
                } catch (e) {
                    console.error("Error al inicializar EasyCam:", e);
                    updateLoadingText("Error en EasyCam (continuando)");
                    // Continuar sin EasyCam
                }
                
                // Iniciar c√°mara web con timeout de seguridad
                updateLoadingText("Solicitando acceso a la c√°mara...");
                let cameraTimeout = setTimeout(function() {
                    updateLoadingText("Timeout en c√°mara, iniciando sin c√°mara");
                    // Continuar sin c√°mara, de todos modos inicializar audio
                    initAudio();
                }, 5000);
                
                try {
                    // En m√≥viles, usar una configuraci√≥n simple
                    let constraints = { video: true };
                    
                    video = createCapture(constraints, function(stream) {
                        clearTimeout(cameraTimeout);
                        updateLoadingText("C√°mara iniciada");
                        canRenderScene = true;
                        canUseCameras = true;
                        video.hide();
                        initAudio();
                    });
                    
                    video.elt.onerror = function(e) {
                        clearTimeout(cameraTimeout);
                        console.error("Error en video:", e);
                        updateLoadingText("Error de c√°mara, continuando...");
                        initAudio();
                    };
                } catch (e) {
                    clearTimeout(cameraTimeout);
                    console.error("Error al iniciar c√°mara:", e);
                    updateLoadingText("Error cr√≠tico de c√°mara");
                    initAudio();
                }
                
                // Ajustes b√°sicos para el rendimiento
                frameRate(isMobile ? 24 : 30);
                
            } catch (e) {
                console.error("Error cr√≠tico en setup:", e);
                updateLoadingText("Error cr√≠tico: " + e.message);
                // Forzar finalizaci√≥n de carga en caso de error
                setTimeout(hideLoading, 1000);
                updateStatus("Error en inicializaci√≥n");
            }
        }
        
        // NUEVO: Funci√≥n separada para inicializar audio
        function initAudio() {
            updateLoadingText("Configurando audio...");
            
            try {
                userStartAudio().then(() => {
                    try {
                        mic = new p5.AudioIn();
                        mic.start();
                        updateLoadingText("Audio iniciado");
                    } catch (e) {
                        console.error("Error al iniciar micr√≥fono:", e);
                    }
                    
                    // Configurar grabaci√≥n si est√° disponible
                    if (canRecord) {
                        try {
                            setupRecorder();
                        } catch (e) {
                            console.error("Error al configurar grabaci√≥n:", e);
                            canRecord = false;
                            recordButton.style.display = 'none';
                        }
                    }
                    
                    // Todo inicializado, ocultar pantalla de carga
                    setTimeout(hideLoading, 1000);
                    updateStatus("Listo");
                    
                }).catch(e => {
                    console.error("Error al iniciar audio:", e);
                    updateLoadingText("Sin acceso a audio");
                    setTimeout(hideLoading, 1000);
                    updateStatus("Sin audio");
                });
            } catch (e) {
                console.error("Error cr√≠tico en audio:", e);
                updateLoadingText("Error cr√≠tico de audio");
                setTimeout(hideLoading, 1000);
                updateStatus("Error de audio");
            }
        }

        // Simplified camera toggle for mobile
        function toggleCamera() {
            try {
                usingBackCamera = !usingBackCamera;
                updateStatus(usingBackCamera ? "C√°mara trasera" : "C√°mara frontal");
                
                if (video) {
                    video.remove();
                }
                
                let constraints = {
                    video: {
                        facingMode: (usingBackCamera ? 'environment' : 'user')
                    }
                };
                
                video = createCapture(constraints);
                video.hide();
                
                vibrateDevice(50);
            } catch (e) {
                console.error("Error al cambiar c√°mara:", e);
                updateStatus("Error al cambiar c√°mara");
            }
        }

        function setupRecorder() {
            try {
                // Simplificar para m√≥viles
                const stream = document.querySelector('canvas').captureStream(24);
                recorder = new MediaRecorder(stream);
                
                recorder.ondataavailable = e => {
                    if (e.data.size) {
                        chunks.push(e.data);
                    }
                };
                
                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    chunks = [];
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    document.body.appendChild(a);
                    a.style = 'display: none';
                    a.href = url;
                    a.download = 'visual3d-' + Date.now() + '.webm';
                    a.click();
                    window.URL.revokeObjectURL(url);
                    updateStatus("Grabaci√≥n guardada");
                };
            } catch (e) {
                console.error("Error al configurar grabaci√≥n:", e);
                recordButton.style.display = 'none';
                canRecord = false;
            }
        }

        function updateStatus(message) {
            if (statusElement) {
                statusElement.innerHTML = message;
            }
        }

        function takePhoto() {
            try {
                saveCanvas('visual3d-' + Date.now(), 'png');
                updateStatus('Imagen guardada');
                
                vibrateDevice();
                
                // Efecto visual de flash
                let flash = document.createElement('div');
                flash.style.position = 'fixed';
                flash.style.top = '0';
                flash.style.left = '0';
                flash.style.width = '100%';
                flash.style.height = '100%';
                flash.style.backgroundColor = 'white';
                flash.style.opacity = '0.7';
                flash.style.zIndex = '9999';
                flash.style.pointerEvents = 'none';
                document.body.appendChild(flash);
                
                setTimeout(() => {
                    flash.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(flash);
                    }, 300);
                }, 100);
            } catch (e) {
                console.error("Error al tomar foto:", e);
                updateStatus("Error al guardar imagen");
            }
        }
        
        function toggleRecording() {
            if (!canRecord) {
                updateStatus("Grabaci√≥n no disponible");
                return;
            }
            
            try {
                recording = !recording;
                if (recording) {
                    chunks = [];
                    recorder.start();
                    updateStatus('Grabando...');
                    recordButton.textContent = "‚èπÔ∏è Detener";
                    recordButton.style.backgroundColor = "rgba(255,0,0,0.4)";
                } else {
                    recorder.stop();
                    updateStatus('Procesando grabaci√≥n...');
                    recordButton.textContent = "üî¥ Grabar";
                    recordButton.style.backgroundColor = "";
                }
                vibrateDevice();
            } catch (e) {
                console.error("Error en grabaci√≥n:", e);
                updateStatus("Error de grabaci√≥n");
            }
        }
        
        function cycleEffect() {
            if (depthFactor === 2.0) {
                depthFactor = 3.0;
                effectIntensity = 1.5;
                updateStatus("Efecto: Ondas");
            } else if (depthFactor === 3.0) {
                depthFactor = 4.0;
                effectIntensity = 2.0;
                updateStatus("Efecto: Monta√±as");
            } else {
                depthFactor = 2.0;
                effectIntensity = 1.0;
                updateStatus("Efecto: Normal");
            }
            vibrateDevice();
        }
        
        function togglePreview() {
            showPreview = !showPreview;
            previewElement.style.display = showPreview ? 'block' : 'none';
            updateStatus(showPreview ? "Previsualizaci√≥n activada" : "Previsualizaci√≥n desactivada");
            vibrateDevice();
        }

        // MODIFICADO: Simplificar completamente la funci√≥n draw para dispositivos m√≥viles
        function draw() {
            try {
                background(0);
                
                // Actualizar medidor de audio si est√° disponible
                if (mic) {
                    audioLevel = mic.getLevel();
                    let decibelPercentage = min(audioLevel * 500, 100);
                    if (audioMeterFill) {
                        audioMeterFill.style.width = decibelPercentage + "%";
                    }
                }
                
                // Si se activ√≥ el modo de emergencia, renderizar solo un objeto simple
                if (fallbackModeActive) {
                    translate(0, 0, -200);
                    rotateX(frameCount * 0.01);
                    rotateY(frameCount * 0.02);
                    fill(100, 200, 255);
                    box(100);
                    return;
                }
                
                // Comprobar si el video est√° listo para renderizar
                if (video && video.loadedmetadata && video.width > 0) {                
                    // Cargar pixels de video
                    try {
                        video.loadPixels();
                    } catch (e) {
                        console.error("Error al cargar pixels:", e);
                        return; // Salir si no se pueden cargar los pixels
                    }
                    
                    // Calcular efecto de audio
                    let volume = audioLevel * 2000 * effectIntensity;
                    offset += 0.05;
                    
                    // Centro del video y de la pantalla
                    let centerX = video.width / 2;
                    let centerY = video.height / 2;
                    
                    // Ajustar origen al centro
                    translate(-width / 2, -height / 2, 0);
                    
                    // Configurar salto para mejor rendimiento en m√≥viles
                    let skipAmount = isMobile ? pointDensity * 2 : pointDensity;
                    
                    // Renderizar esferas
                    for (let y = 0; y < video.height; y += skipAmount) {
                        for (let x = 0; x < video.width; x += skipAmount) {
                            // Validar √≠ndices
                            if (x >= video.width || y >= video.height) continue;
                            
                            let index = (y * video.width + x) * 4;
                            if (index >= video.pixels.length - 4) continue;
                            
                            let r = video.pixels[index];
                            let g = video.pixels[index + 1];
                            let b = video.pixels[index + 2];
                            
                            // Solo renderizar si hay suficiente color
                            if (r + g + b > 30) {
                                let bright = (r + g + b) / 3;
                                let z = map(bright, 0, 255, -150 * depthFactor, 150);
                                
                                // Aplicar efecto de audio
                                let d = dist(x, y, centerX, centerY);
                                z += sin(d/10 + offset) * volume * 0.5;
                                
                                // Mostrar color central
                                if (abs(x - centerX) < 10 && abs(y - centerY) < 10) {
                                    colorSample.style.backgroundColor = `rgb(${r},${g},${b})`;
                                }
                                
                                // Dibujar esfera
                                push();
                                translate(x, y, z - 100);
                                fill(r, g, b);
                                noStroke();
                                sphere(sphereSize);
                                pop();
                            }
                        }
                    }
                    
                    // Actualizar estado ocasionalmente
                    if (frameCount % 30 === 0) {
                        updateStatus(`FPS: ${floor(frameRate())}`);
                    }
                }
            } catch (e) {
                console.error("Error en draw:", e);
            }
        }

        // Prevenir eventos de scroll
        function touchStarted() {
            return false;
        }
        
        function touchMoved() {
            return false;
        }

        function windowResized() {
            try {
                resizeCanvas(windowWidth, windowHeight);
                if (easycam) {
                    easycam.setViewport([0, 0, windowWidth, windowHeight]);
                }
            } catch (e) {
                console.error("Error al redimensionar:", e);
            }
        }
    </script>
</body>
</html>
